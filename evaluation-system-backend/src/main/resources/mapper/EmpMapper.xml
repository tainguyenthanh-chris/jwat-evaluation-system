<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.clt.evaluation_system_backend.mapper.EmpMapper">

    <resultMap id="EmpResultMap" type="com.clt.evaluation_system_backend.model.Emp">
        <id property="empId" column="emp_id" />

        <result property="empNm" column="emp_nm" />
        <result property="empNo" column="emp_no" />
        <result property="empEmail" column="emp_email" />
        <result property="compRoleCd" column="comp_role_cd" />
        <result property="deptCd" column="dept_cd" />
        <result property="posCd" column="pos_cd" />
        <result property="lvlCd" column="lvl_cd" />
        <result property="salaryLvl" column="salary_lvl" />
        <result property="teamId" column="team_id" />
        <result property="empStatusCd" column="emp_status_cd" />

        <result property="creUsrId" column="cre_usr_id" />
        <result property="creDt" column="cre_dt" />
        <result property="updUsrId" column="upd_usr_id" />
        <result property="updDt" column="upd_dt" />
        <result property="delFlg" column="del_flg" />
    </resultMap>

    <resultMap id="EmpWithFormResultMap" type="com.clt.evaluation_system_backend.dto.response.employee.EmployeeWithFormResponse">
        <result property="employeeId" column="emp_Id"/>
        <result property="employeeNumber" column="emp_no"/>
        <result property="employeeName"   column="emp_nm"/>
        <result property="employeeEmail"   column="emp_email"/>
        <result property="departmentCode" column="dept_cd"/>
        <result property="positionCode" column="pos_cd"/>
        <result property="levelCode" column="lvl_cd"/>
        <result property="nextReviewDate" column="next_rev_dt"/>
        <result property="salaryLevel" column="salary_lvl"/>
        <result property="formId"         column="form_id"/>
    </resultMap>

    <select id="findByEmail"
        parameterType="string"
        resultMap="EmpResultMap"> SELECT emp_id, emp_nm, emp_no, emp_email, comp_role_cd, dept_cd,
        pos_cd, lvl_cd, salary_lvl, team_id, emp_status_cd, cre_usr_id, cre_dt, upd_usr_id, upd_dt,
        del_flg FROM emp WHERE emp_email = #{email} AND del_flg = 'F' </select>


    <resultMap id="EmpResultMapListAllBossRev"
        type="com.clt.evaluation_system_backend.model.Emp">

        <!-- EMP -->
        <id property="empId" column="emp_id" />
        <result property="empNm" column="emp_nm" />
        <result property="empNo" column="emp_no" />
        <result property="empEmail" column="emp_email" />
        <result property="compRoleCd" column="comp_role_cd" />
        <result property="deptCd" column="dept_cd" />
        <result property="posCd" column="pos_cd" />
        <result property="lvlCd" column="lvl_cd" />
        <result property="salaryLvl" column="salary_lvl" />
        <result property="teamId" column="team_id" />
        <result property="empStatusCd" column="emp_status_cd" />

        <!-- FORM_SUBM -->
        <association property="formSubm"
            javaType="com.clt.evaluation_system_backend.model.FormSubm">

            <id property="formSubmId" column="form_subm_id" />
            <result property="formId" column="form_id" />
            <result property="empId" column="fs_emp_id" />
            <result property="empNm" column="fs_emp_nm" />
            <result property="empNo" column="fs_emp_no" />
            <result property="empCurrDeptCd" column="emp_curr_dept_cd" />
            <result property="empCurrPosCd" column="emp_curr_pos_cd" />
            <result property="empCurrLvlCd" column="emp_curr_lvl_cd" />
            <result property="revDt" column="rev_dt" />
            <result property="nextRevDt" column="next_rev_dt" />
            <result property="formSubmStatus" column="form_subm_status" />

            <!-- FORM -->
            <association property="form"
                javaType="com.clt.evaluation_system_backend.model.Form">
                <id property="formId" column="f_form_id" />
                <result property="formTitle" column="form_title" />
                <result property="formVer" column="form_ver" />
                <result property="deptCd" column="f_dept_cd" />
                <result property="posCd" column="f_pos_cd" />
                <result property="lvlCd" column="f_lvl_cd" />
                <result property="formStatus" column="form_status" />
            </association>

            <!-- BOSS_REV LIST -->
            <collection property="bossRevList"
                ofType="com.clt.evaluation_system_backend.model.BossRev">

                <id property="bossRevId" column="boss_rev_id" />
                <result property="formSubmId" column="form_subm_id" />
                <result property="empNo" column="br_emp_no" />
                <result property="bossNo" column="boss_no" />
                <result property="bossRevRole" column="boss_rev_role" />
                <result property="bossRevOrdNo" column="boss_rev_ord_no" />
                <result property="isFinal" column="isFinal" />


                <association property="bossEmp"
                    javaType="com.clt.evaluation_system_backend.model.Emp">
                    <id property="empId" column="boss_emp_id" />
                    <result property="empNm" column="boss_emp_nm" />
                    <result property="empNo" column="boss_emp_no" />
                    <result property="empEmail" column="boss_emp_email" />
                    <result property="compRoleCd" column="boss_comp_role_cd" />
                    <result property="deptCd" column="boss_dept_cd" />
                    <result property="posCd" column="boss_pos_cd" />
                    <result property="lvlCd" column="boss_lvl_cd" />
                    <result property="salaryLvl" column="boss_salary_lvl" />
                    <result property="teamId" column="boss_team_id" />
                    <result property="empStatusCd" column="boss_emp_status_cd" />
                </association>

            </collection>


        </association>

    </resultMap>

    <!-- =========================
         SELECT
    ========================== -->
    <select id="findEmpByBossNo"
        parameterType="string"
        resultMap="EmpResultMapListAllBossRev"> WITH ranked_form_subm AS ( SELECT fs.*, ROW_NUMBER()
        OVER ( PARTITION BY fs.emp_no ORDER BY CASE WHEN fs.form_subm_status = 'PENDING' THEN 0 ELSE
        1 END, fs.rev_dt DESC ) AS rn FROM form_subm fs WHERE fs.del_flg = 'F' ) SELECT e.emp_id,
        e.emp_nm, e.emp_no, e.emp_email, e.comp_role_cd, e.dept_cd, e.pos_cd, e.lvl_cd,
        e.salary_lvl, e.team_id, e.emp_status_cd, fs.form_subm_id, fs.form_id, fs.emp_id AS
        fs_emp_id, fs.emp_nm AS fs_emp_nm, fs.emp_no AS fs_emp_no, fs.emp_curr_dept_cd,
        fs.emp_curr_pos_cd, fs.emp_curr_lvl_cd, fs.rev_dt, fs.next_rev_dt, fs.form_subm_status,
        f.form_title, f.form_ver, f.dept_cd AS f_dept_cd, f.pos_cd AS f_pos_cd, f.lvl_cd AS
        f_lvl_cd, f.form_status, br.boss_rev_id, br.boss_no, br.boss_rev_role, br.boss_rev_ord_no,
        br.isFinal, e2.emp_id AS boss_emp_id, e2.emp_nm AS boss_emp_nm, e2.emp_no AS boss_emp_no
        FROM emp e JOIN ranked_form_subm fs ON e.emp_no = fs.emp_no AND fs.rn = 1 JOIN form f ON
        fs.form_id = f.form_id AND f.del_flg = 'F' LEFT JOIN boss_rev br ON fs.form_subm_id =
        br.form_subm_id AND br.del_flg = 'F' LEFT JOIN emp e2 ON e2.emp_no = br.boss_no AND
        e2.del_flg = 'F' WHERE e.del_flg = 'F' AND EXISTS ( SELECT 1 FROM boss_rev br2 WHERE
        br2.form_subm_id = fs.form_subm_id AND br2.boss_no = #{bossNo} AND br2.del_flg = 'F' ) ORDER
        BY e.emp_no, br.boss_rev_ord_no; </select>

    <select id="findAll" resultMap="EmpResultMap"> SELECT emp_id, emp_nm, emp_no, emp_email,
        comp_role_cd, dept_cd, pos_cd, lvl_cd, salary_lvl, team_id, emp_status_cd, cre_usr_id,
        cre_dt, upd_usr_id, upd_dt, del_flg FROM emp WHERE del_flg = 'F' ORDER BY emp_no ;</select>

    <select id="selectEmployeesForNextReviewWithForm" resultMap="EmpWithFormResultMap">
        SELECT
            e.emp_id,
            e.emp_no,
            e.emp_nm,
            e.emp_email,
            e.dept_cd,
            e.pos_cd,
            e.lvl_cd,
            e.next_rev_dt,
            e.salary_lvl,
            f.form_id
        FROM emp e
        LEFT JOIN form f
            ON f.form_id = (
                SELECT f2.form_id
                FROM form f2
                WHERE f2.del_flg = 'F'
                    AND f2.form_status != 'OLD'
                    AND f2.dept_cd = e.dept_cd
                    AND f2.pos_cd  = e.pos_cd
                    AND f2.lvl_cd  = e.lvl_cd
                    LIMIT 1
            )
        WHERE e.del_flg = 'F'
          AND e.emp_status_cd = 'ACTIVE'
          AND e.next_rev_dt IS NOT NULL
          AND DATE_TRUNC('month', e.next_rev_dt) = DATE_TRUNC('month', CURRENT_DATE + INTERVAL '1 month')
        ORDER BY e.emp_no
    </select>

    <select id="selectForAdm" resultType="com.clt.evaluation_system_backend.dto.response.AdmEmployeeResponse">
        SELECT
            E.emp_id    AS employeeId,
            E.emp_no    AS employeeNo,
            E.emp_nm    AS employeeName,
            E.emp_email AS employeeEmail,
            E.dept_cd || '-' || E.pos_cd || '-' || E.lvl_cd AS employeeInfo,
            STRING_AGG(
                    BR.boss_no || '-' || B.emp_nm,
                    ', '
                        ORDER BY BR.boss_rev_ord_no ASC
            ) AS reviewByListRaw

        FROM emp E
                 LEFT JOIN boss_rev BR
                           ON BR.emp_no = E.emp_no AND BR.form_subm_id IS NULL
                 LEFT JOIN emp B
                           ON B.emp_no = BR.boss_no
        WHERE E.del_flg = 'F'
            <choose>
                <when test="employeeNo != null and employeeNo != ''">
                    AND E.emp_no = #{employeeNo}
                </when>
                <when test="employeeName != null and employeeName != ''">
                    AND LOWER(E.emp_nm) LIKE CONCAT('%', LOWER(#{employeeName}), '%')
                </when>
                <otherwise>
                </otherwise>
            </choose>
        GROUP BY
            E.emp_id,
            E.emp_no,
            E.emp_nm,
            E.emp_email,
            E.dept_cd,
            E.pos_cd,
            E.lvl_cd
        ORDER BY E.emp_no;
    </select>

    <select id="selectByNo" resultType="com.clt.evaluation_system_backend.dto.response.AdmEmployeeResponse">
        SELECT
            E.emp_no    AS employeeNo,
            E.emp_nm    AS employeeName
        FROM emp E
        WHERE E.del_flg = 'F'
        <if test="employeeNo != null">
            AND E.emp_no  = #{employeeNo}
        </if>
    </select>

    <select id="selectReviewingEmployee" resultType="com.clt.evaluation_system_backend.dto.response.ReviewingEmployeeResponse">
        SELECT
            E.emp_no AS employeeNo,
            E.emp_nm AS employeeName,
            FS.form_subm_status AS formSubmissionStatusDatabase,
            FS.upd_dt AS reviewOn,
            FS.rev_dt AS reviewDate,

            STRING_AGG(
                    BR2.boss_rev_role,
                    ', '
                        ORDER BY BR2.boss_rev_ord_no
            ) AS reviewRoleRaw,
            BR_CUR.boss_rev_role AS currentBossRole
        FROM form_subm FS
                 JOIN emp E
                      ON E.emp_no = FS.emp_no
                 JOIN boss_rev BR2
                      ON BR2.form_subm_id = FS.form_subm_id
                 JOIN boss_rev BR_CUR
                      ON BR_CUR.form_subm_id = FS.form_subm_id
                          AND BR_CUR.boss_no = #{bossNo}
        WHERE FS.form_subm_status != 'FINAL'
        GROUP BY
            E.emp_no,
            E.emp_nm,
            FS.form_subm_status,
            FS.upd_dt,
            BR_CUR.boss_rev_role,
            FS.rev_dt

        ORDER BY E.emp_no;

    </select>


</mapper>