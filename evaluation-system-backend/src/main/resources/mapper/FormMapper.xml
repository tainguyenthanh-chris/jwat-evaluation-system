<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.clt.evaluation_system_backend.mapper.FormMapper">

<!--    selectFormTmplItem by dept, pos, lvl-->
    <select id="selectActiveFormTmplItem" resultType="com.clt.evaluation_system_backend.dto.response.FormTmplItemResponse">
        SELECT
            f.form_id AS formId,
            f.dept_cd AS departmentCode,
            f.pos_cd AS positionCode,
            f.lvl_cd AS levelCode,
            st.sec_id AS sectionId,
            st.sec_title as sectionTitle,
            ft.sec_ord_no as sectionOrderNo,
            cri.criteria_id  AS criteriaId,
            cri.criteria_cnt as criteriaContent,
            ft.criteria_ord_no as criteriaOrderNo,
            rc.rev_conf_type AS type,
            rc.rev_conf_roles AS roles
        FROM form_tmpl ft
                 LEFT JOIN criteria cri ON cri.criteria_id = ft.criteria_id
                 LEFT JOIN sec st ON st.sec_id = ft.sec_id
                 LEFT JOIN form f ON f.form_id = ft.form_id
                 LEFT JOIN rev_conf rc ON rc.rev_conf_cd = ft.rev_conf_cd

        WHERE f.dept_cd = #{department}
                AND f.pos_cd = #{position}
                AND f.lvl_cd = #{level}
                AND f.form_status != 'OLD'
                AND f.del_flg != 'T'
                AND st.sec_status != 'OLD'
                AND st.del_flg != 'T'
                AND cri.criteria_status != 'OLD'
                AND cri.del_flg != 'T'
                ORDER BY ft.sec_ord_no, ft.criteria_ord_no ASC;
    </select>

    <select id="selectFormTmplItemByFormId" resultType="com.clt.evaluation_system_backend.dto.response.FormTmplItemResponse">
        SELECT
            f.form_id AS formId,
            f.dept_cd AS departmentCode,
            f.pos_cd AS positionCode,
            f.lvl_cd AS levelCode,
            st.sec_id AS sectionId,
            st.sec_title as sectionTitle,
            ft.sec_ord_no as sectionOrderNo,
            cri.criteria_id  AS criteriaId,
            cri.criteria_cnt as criteriaContent,
            ft.criteria_ord_no as criteriaOrderNo,
            rc.rev_conf_type AS type,
            rc.rev_conf_roles AS roles
        FROM form_tmpl ft
                 LEFT JOIN criteria cri ON cri.criteria_id = ft.criteria_id
                 LEFT JOIN sec st ON st.sec_id = ft.sec_id
                 LEFT JOIN form f ON f.form_id = ft.form_id
                 LEFT JOIN rev_conf rc ON rc.rev_conf_cd = ft.rev_conf_cd

        WHERE f.form_id = #{formId}
        ORDER BY ft.sec_ord_no, ft.criteria_ord_no ASC;
    </select>

    <select id="selectFormDetail" resultType="com.clt.evaluation_system_backend.dto.response.FormDetailResponse">
        SELECT
            F.dept_cd AS departmentCode,
            F.pos_cd AS positionCode,
            F.lvl_cd AS levelCode,
            FD.form_detail_id AS formDetailId,
            FD.form_id AS formId,
            FD.sec_id AS sectionId,
            FD.parent_sec_id AS parentSectionId,
            FD.form_detail_ord_no AS formDetailOrderNo,
            FD.form_detail_title AS formDetailTitle,
            RC.rev_conf_cd AS reviewConfigCode,
            RC.rev_conf_type AS reviewConfigType,
            RC.rev_conf_roles AS reviewConfigRoleJson
        FROM form F
             LEFT JOIN form_detail FD ON FD.form_id = F.form_id
             LEFT JOIN rev_conf RC ON RC.rev_conf_cd = FD.rev_conf_cd
        WHERE
            F.del_flg = 'F'
            AND F.form_status != 'OLD'
            AND F.dept_cd = #{department}
            AND F.pos_cd = #{position}
            AND F.lvl_cd = #{level}
        ORDER BY FD.form_detail_ord_no;
    </select>

    <insert id="insertSubmList">
        INSERT INTO subm_value (
            form_subm_id,
            form_detail_id,
            subm_value_role,
            subm_value
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.formSubmissionId},
            #{item.formDetailId},
            #{item.role},
            #{item.value}
            )
        </foreach>
    </insert>

    <insert id="insertForm" parameterType="com.clt.evaluation_system_backend.model.Form">
        INSERT INTO form (
            form_id,
            form_title,
            form_ver,
            dept_cd,
            pos_cd,
            lvl_cd,
            form_status,
            cre_usr_id,
            cre_dt,
            del_flg
        )
        VALUES (
            #{formId},
            #{formTitle},
            1,
            #{deptCd},
            #{posCd},
            #{lvlCd},
            'NEW',
            #{creUsrId},
            CURRENT_TIMESTAMP,
            'F'
        )
    </insert>

    <insert id="insertFormDetails" parameterType="java.util.List">
        INSERT INTO form_detail (
            form_id,
            sec_id,
            parent_sec_id,
            form_detail_ord_no,
            form_detail_title,
            rev_conf_cd,
            cre_usr_id,
            cre_dt,
            del_flg
        )
        VALUES
            <foreach collection="list" item="item" separator=",">
                (
                    #{item.formId},
                    #{item.secId},
                    #{item.parentSecId},
                    #{item.formDetailOrdNo},
                    #{item.formDetailTitle},
                    #{item.revConfCd},
                    #{item.creUsrId},
                    CURRENT_TIMESTAMP,
                    'F'
                )
            </foreach>
    </insert>
</mapper>
